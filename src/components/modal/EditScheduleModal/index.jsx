import PropTypes from 'prop-types';
import { useState, useEffect } from 'react';
import DaySelectModal from '@/components/modal/DaySelectModal';
import TimeSelectModal from '@/components/modal/TimeSelectModal';
import selectIcon from '@/assets/img/icon/dropdown.svg';
import crossIcon from '@/assets/img/icon/cross.svg';
import * as S from './style';

export async function updateFixedSchedule(userId, scheduleId, fixedSchedule) {
  // 데이터 콘솔 출력
  console.log('[EditScheduleModal] updateFixedSchedule 호출', {
    userId,
    scheduleId,
    fixedSchedule,
  });

  // 실제 서버 요청은 주석 처리
  /*
  try {
    const response = await fetch(
      `${import.meta.env.VITE_SERVER_API_URL}/user/${userId}/fixed-schedules/${scheduleId}`,
      {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ fixedSchedule }),
      },
    );
    const data = await response.json();
    if (!response.ok || !data.success) {
      throw new Error(data.error?.message || '수정에 실패했습니다.');
    }
    return { success: true };
  } catch (error) {
    return { success: false, error: error.message || '네트워크 오류' };
  }
  */
  // 서버 없이 성공 처리
  return { success: true };
}

const EditScheduleModal = ({ isOpen, schedule, userId, onClose, onUpdate }) => {
  const [form, setForm] = useState({
    title: '',
    day: '월요일',
    startTime: { hour: '09', minute: '00' },
    endTime: { hour: '18', minute: '00' },
  });
  const [modalType, setModalType] = useState(null);

  useEffect(() => {
    if (schedule) {
      setForm({
        title: schedule.title || '',
        day: schedule.day || '월요일',
        startTime: {
          hour: String(schedule.startTime.hour).padStart(2, '0'),
          minute: String(schedule.startTime.minute).padStart(2, '0'),
        },
        endTime: {
          hour: String(schedule.endTime.hour).padStart(2, '0'),
          minute: String(schedule.endTime.minute).padStart(2, '0'),
        },
      });
    }
  }, [schedule]);

  if (!isOpen || !schedule) return null;

  const openModal = (type) => setModalType(type);
  const closeModal = () => setModalType(null);

  const handleDaySelect = (day) => {
    setForm((prev) => ({ ...prev, day }));
    closeModal();
  };

  const handleStartTimeSelect = (time) => {
    setForm((prev) => ({ ...prev, startTime: time }));
    closeModal();
  };

  const handleEndTimeSelect = (time) => {
    setForm((prev) => ({ ...prev, endTime: time }));
    closeModal();
  };

  const handleChange = (e) => {
    setForm((prev) => ({ ...prev, [e.target.name]: e.target.value }));
  };

  const handleSubmit = async (e) => {
    e.preventDefault();

    // 서버가 요구하는 형식으로 변환
    const fixedSchedule = {
      id: schedule.scheduleId, // 또는 schedule.id
      day: form.day,
      startTime: `${form.startTime.hour}:${form.startTime.minute}`,
      endTime: `${form.endTime.hour}:${form.endTime.minute}`,
      title: form.title, // title 필드가 필요하다면 포함
    };

    const result = await updateFixedSchedule(userId, schedule.scheduleId, fixedSchedule);
    if (result.success) {
      onUpdate({
        ...schedule,
        ...form,
        startTime: { ...form.startTime },
        endTime: { ...form.endTime },
      });
    } else {
      alert(result.error || '수정에 실패했습니다.');
    }
  };

  return (
    <>
      <S.Overlay>
        <S.TopBar>
          <S.CloseButton onClick={onClose} aria-label="close">
            <img src={crossIcon} alt="Close" />
          </S.CloseButton>
          <S.AddScheduleTitle>일정 수정</S.AddScheduleTitle>
          <S.SubmitButton type="button" onClick={handleSubmit}>
            저장
          </S.SubmitButton>
        </S.TopBar>
        <S.Slide>
          <S.ScheduleInput
            name="title"
            value={form.title}
            onChange={handleChange}
            placeholder="일정명"
            required
          />
          <S.Divider />
          <S.TableSetting>
            <S.DayTimeSelect>
              <S.DaySelectButton type="button" onClick={() => openModal('day')}>
                {form.day}
                <img src={selectIcon} alt="Select Day" />
              </S.DaySelectButton>
              <S.TimeRow>
                <S.TimeButton type="button" onClick={() => openModal('start')}>
                  {form.startTime.hour}:{form.startTime.minute}
                  <img src={selectIcon} alt="Select Time" />
                </S.TimeButton>
              </S.TimeRow>
              <S.TimeRow>
                <S.TimeButton type="button" onClick={() => openModal('end')}>
                  {form.endTime.hour === '00' && form.endTime.minute === '00'
                    ? '24:00'
                    : `${form.endTime.hour}:${form.endTime.minute}`}
                  <img src={selectIcon} alt="Select Time" />
                </S.TimeButton>
              </S.TimeRow>
            </S.DayTimeSelect>
          </S.TableSetting>
        </S.Slide>
      </S.Overlay>
      <DaySelectModal
        isOpen={modalType === 'day'}
        onClose={closeModal}
        onSelect={handleDaySelect}
      />
      <TimeSelectModal
        isOpen={modalType === 'start'}
        onClose={closeModal}
        onSelect={handleStartTimeSelect}
        initialHour={form.startTime.hour}
        initialMinute={form.startTime.minute}
      />
      <TimeSelectModal
        isOpen={modalType === 'end'}
        onClose={closeModal}
        onSelect={handleEndTimeSelect}
        initialHour={form.endTime.hour}
        initialMinute={form.endTime.minute}
        isEnd
      />
    </>
  );
};

EditScheduleModal.propTypes = {
  isOpen: PropTypes.bool.isRequired,
  schedule: PropTypes.object,
  userId: PropTypes.oneOfType([PropTypes.string, PropTypes.number]).isRequired, // 추가
  onClose: PropTypes.func.isRequired,
  onUpdate: PropTypes.func.isRequired,
};

export default EditScheduleModal;
